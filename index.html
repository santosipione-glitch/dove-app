<!DOCTYPE html>
<!-- TEST DI MODIFICA PER FORZARE IL SALVATAGGIO -->
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dov'è - Prototipo V3 (Database)</title>

    <!-- PWA Stuff -->
    <meta name="theme-color" content="#3b82f6">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/3b82f6/FFFFFF?text=D">

    <!-- Tailwind & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- !!! INIZIO MODIFICA: Supabase SDK !!! -->
    <!-- Carica il client JavaScript di Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- !!! FINE MODIFICA !!! -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; 
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        .risultato-item {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stile Titolo Dinamico */
        .title-pulse {
            animation: title-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes title-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-top: 1px solid #e5e7eb;
            background-color: white;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        /* Stile per il Floating Action Button (FAB) */
        .fab {
            position: fixed;
            bottom: 80px; /* Sopra la nav bar */
            right: 20px;
            z-index: 1001; /* Sopra la nav bar */
        }
    </style>
</head>
<body class="antialiased">

    <!-- 
      Schermata di Login
      Visibile di default, nascosta quando l'utente è loggato.
    -->
    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-600">
                Dov<span class="text-amber-500 title-pulse">'è</span>
            </h1>
            <p class="text-gray-500 text-lg mt-2">Accedi al tuo archivio domestico.</p>
        </div>
        
        <div id="loading-message" class="text-center text-gray-500 mb-4">
            <p>Connessione in corso...</p>
        </div>

        <div id="auth-buttons" class="w-full max-w-xs space-y-3 hidden">
            <button id="google-login-button" class="w-full bg-white text-gray-700 font-semibold py-3 px-4 rounded-lg shadow-md border border-gray-300 flex items-center justify-center hover:bg-gray-50 transition-colors">
                <img src="https://placehold.co/24x24/ffffff/000000?text=G" alt="Google Logo" class="mr-3"><!-- Sostituire con vera icona Google -->
                Accedi con Google
            </button>
            <!-- Aggiungi altri bottoni (Email, Apple, etc.) qui se vuoi -->
        </div>
    </div>

    <!-- 
      Contenitore Principale dell'App
      Nascosto di default, visibile solo dopo il login.
    -->
    <div id="app-container" class="hidden">
        
        <!-- Contenitore app con padding per la bottom-nav -->
        <div id="app" class="pb-24">
            
            <!-- Schermata Cerca (Default) -->
            <div id="tab-cerca">
                <!-- Header -->
                <header class="bg-white shadow-sm p-4 sticky top-0 z-10">
                    <div class="max-w-md mx-auto flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-blue-600">
                            Dov<span class="text-amber-500 title-pulse">'è</span>
                        </h1>
                        <button id="sign-out-button" class="text-sm text-gray-500 hover:text-blue-600">
                            Esci
                        </button>
                    </div>
                </header>

                <!-- Contenuto principale -->
                <main class="max-w-md mx-auto p-4">
                    
                    <!-- Barra di Ricerca -->
                    <div class="relative mb-6">
                        <input type="text" id="search-input" placeholder="Cerca passaporto, batterie..." class="w-full px-5 py-3 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <i class="ph ph-magnifying-glass absolute left-5 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>

                    <!-- Risultati della Ricerca -->
                    <div id="search-results" class="space-y-4">
                        <!-- I risultati verranno iniettati qui dal JS -->
                    </div>

                    <!-- Messaggio di default o nessun risultato -->
                    <div id="default-message" class="text-center text-gray-400 mt-10 p-4 rounded-lg bg-gray-50">
                        <!-- Questo verrà aggiornato dinamicamente dal JS -->
                    </div>
                </main>
            </div>

            <!-- Schermata Premium (Nascosta per ora) -->
            <div id="tab-premium" class="hidden">
                 <!-- Contenuto Premium -->
            </div>

        </div>

        <!-- Pulsante "+" Aggiungi Oggetto (FAB) -->
        <button id="open-add-modal-button" class="fab bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 transition-transform transform hover:scale-110">
            <i class="ph ph-plus text-3xl"></i>
        </button>

        <!-- Barra di Navigazione Inferiore -->
        <nav class="bottom-nav flex justify-around max-w-md mx-auto">
            <button id="nav-cerca" class="flex-1 text-center py-3 text-blue-600 border-t-2 border-blue-600">
                <i class="ph ph-magnifying-glass text-2xl"></i>
                <span class="text-xs block">Cerca</span>
            </button>
            <button id="nav-premium" class="flex-1 text-center py-3 text-gray-500">
                <i class="ph ph-rocket-launch text-2xl"></i>
                <span class="text-xs block">Premium</span>
            </button>
        </nav>
    </div>


    <!-- Modale (popup) per i DETTAGLI dell'oggetto -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[1050] hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full">
            <img id="modal-img" src="" alt="Foto del luogo" class="w-full h-48 object-cover rounded-t-xl">
            <div class="p-5">
                <h2 id="modal-title" class="text-2xl font-bold mb-2"></h2>
                <p class="text-gray-600 mb-4">Si trova in:</p>
                <div class="bg-gray-100 p-3 rounded-lg mb-4">
                    <strong id="modal-location" class="text-gray-800"></strong>
                </div>
                <p class="text-gray-600 mb-2">Note aggiuntive:</p>
                <div class="bg-gray-100 p-3 rounded-lg min-h-[50px]">
                    <em id="modal-notes" class="text-gray-800"></em>
                </div>
            </div>
            <div class="p-4 bg-gray-50 rounded-b-xl">
                <button id="close-detail-modal" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    Chiudi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modale (popup) per AGGIUNGERE un oggetto -->
    <div id="add-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[1050] hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full">
            <form id="add-form">
                <div class="p-5">
                    <h2 class="text-2xl font-bold mb-4">Aggiungi un Oggetto</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="add-nome" class="block text-sm font-medium text-gray-700">Nome Oggetto</label>
                            <input type="text" id="add-nome" name="nome" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="add-posizione" class="block text-sm font-medium text-gray-700">Posizione (es. Cassetto alto)</label>
                            <input type="text" id="add-posizione" name="posizione" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="add-tags" class="block text-sm font-medium text-gray-700">Tag (separati da virgola)</label>
                            <input type="text" id="add-tags" name="tags" placeholder="es. cavi, hdmi, caricatore" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="add-note" class="block text-sm font-medium text-gray-700">Note</label>
                            <textarea id="add-note" name="note" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="add-foto" class="block text-sm font-medium text-gray-700">URL Foto (opzionale)</label>
                            <input type="url" id="add-foto" name="foto" placeholder="https://..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 rounded-b-xl flex space-x-3">
                    <button type="button" id="close-add-modal-button" classs="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors flex-1">
                        Annulla
                    </button>
                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition-colors flex-1">
                        Salva Oggetto
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- 
      INIZIO SCRIPT PRINCIPALE
    -->
    <script type="module">
        // --- 1. CONFIGURAZIONE SUPABASE ---
        // !!! INCOLLA QUI LE TUE CHIAVI SUPABASE !!!
        // Le trovi nel tuo progetto Supabase > Settings > API
        
        const SUPABASE_URL = "INCOLLA_IL_TUO_URL_QUI"; // es. "https://xxxxxx.supabase.co"
        const SUPABASE_ANON_KEY = "INCOLLA_LA_TUA_CHIAVE_ANON_QUI"; // es. "eyJhbGciOi..."
        
        // -------------------------------------------

        // Importa il client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- 2. GESTIONE STATO E VARIABILI GLOBALI ---
        let currentUserId = null; // ID dell'utente loggato
        let luoghiStore = []; // Store locale per i dati live
        const REALTIME_CHANNEL = 'luoghi_channel'; // Canale per gli aggiornamenti
        let channel = null; // Variabile per il canale realtime

        // --- 3. ELEMENTI DOM ---
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loadingMessage = document.getElementById('loading-message');
        const authButtons = document.getElementById('auth-buttons');
        const googleLoginButton = document.getElementById('google-login-button');
        const signOutButton = document.getElementById('sign-out-button');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const defaultMessage = document.getElementById('default-message');
        
        // Modale Dettagli
        const detailModal = document.getElementById('detail-modal');
        const closeDetailModal = document.getElementById('close-detail-modal');
        const modalImg = document.getElementById('modal-img');
        const modalTitle = document.getElementById('modal-title');
        const modalLocation = document.getElementById('modal-location');
        const modalNotes = document.getElementById('modal-notes');

        // Modale Aggiungi
        const addModal = document.getElementById('add-modal');
        const openAddModalButton = document.getElementById('open-add-modal-button');
        const closeAddModalButton = document.getElementById('close-add-modal-button');
        const addForm = document.getElementById('add-form');

        // --- 4. LOGICA DI AUTENTICAZIONE ---

        // Ascolta i cambiamenti dello stato di autenticazione
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (session && session.user) {
                // Utente è loggato
                currentUserId = session.user.id;
                console.log("Utente loggato:", currentUserId);
                
                // Mostra l'app e nascondi il login
                appContainer.classList.remove('hidden');
                loginScreen.classList.add('hidden');
                
                // Carica i dati iniziali e imposta l'ascoltatore
                loadInitialData();
                setupRealtimeListener();

            } else {
                // Utente non è loggato
                currentUserId = null;
                console.log("Utente non loggato.");

                // Mostra il login e nascondi l'app
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                loadingMessage.classList.add('hidden'); // Nascondi il caricamento
                authButtons.classList.remove('hidden'); // Mostra i pulsanti di login
                
                // Smetti di ascoltare i vecchi dati
                if (channel) {
                    supabaseClient.removeChannel(channel);
                    channel = null;
                }
                luoghiStore = []; // Svuota lo store
                renderLuoghi(luoghiStore); // Pulisci la UI
            }
        });

        // Funzione per il Sign-In con Google
        const signInWithGoogle = async () => {
            const { data, error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
            });
            if (error) {
                console.error("Errore Login Google:", error);
            }
        };

        // Funzione per il Sign-Out
        const signOutUser = async () => {
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                console.error("Errore Logout:", error);
            }
        };

        // Collega gli eventi ai pulsanti
        googleLoginButton.addEventListener('click', signInWithGoogle);
        signOutButton.addEventListener('click', signOutUser);

        // --- 5. LOGICA DATABASE (SUPABASE) ---

        // Carica i dati iniziali al login
        async function loadInitialData() {
            if (!currentUserId) return;
            
            console.log("Caricamento dati iniziali...");
            const { data, error } = await supabaseClient
                .from('luoghi') // NOME DELLA TUA TABELLA
                .select('*')    // Seleziona tutto
                .eq('user_id', currentUserId); // Solo i dati dell'utente (se RLS è attiva, questa è una sicurezza in più)

            if (error) {
                console.error("Errore nel caricare i dati:", error.message);
                if (error.message.includes("policy")) {
                    defaultMessage.innerHTML = `<p class="text-red-500">Errore: La sicurezza (RLS) non è configurata correttamente su Supabase. Controlla il Passo 4 della guida.</p>`;
                }
            } else {
                // Ordina in memoria
                luoghiStore = data.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
                console.log("Dati caricati:", luoghiStore);
                renderLuoghi(luoghiStore);
                handleSearch(); // Applica la ricerca (se c'è)
            }
        }

        // Imposta l'ascoltatore in tempo reale (Realtime)
        function setupRealtimeListener() {
            if (channel) { // Se esiste già un canale, rimuovilo
                 supabaseClient.removeChannel(channel);
            }
            console.log("Imposto ascoltatore realtime...");
            
            channel = supabaseClient.channel(REALTIME_CHANNEL)
                .on('postgres_changes', 
                    { 
                        event: '*', // Ascolta tutti gli eventi (INSERT, UPDATE, DELETE)
                        schema: 'public', 
                        table: 'luoghi' // NOME DELLA TUA TABELLA
                        //, filter: `user_id=eq.${currentUserId}` // Filtro per ricevere solo i *propri* aggiornamenti
                    }, 
                    (payload) => {
                        console.log('Modifica realtime ricevuta!', payload);
                        // Un modo semplice per ricaricare i dati quando qualcosa cambia
                        loadInitialData(); 
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('Connesso al canale realtime!');
                    }
                });
        }

        // Aggiunge un nuovo oggetto al database
        async function addItemToDb(event) {
            event.preventDefault(); 
            if (!currentUserId) {
                console.error("Nessun utente loggato, impossibile aggiungere.");
                return;
            }

            // Prendi i dati dal form
            const nome = document.getElementById('add-nome').value;
            const posizione = document.getElementById('add-posizione').value;
            const tags = document.getElementById('add-tags').value;
            const note = document.getElementById('add-note').value;
            const foto = document.getElementById('add-foto').value || `https://placehold.co/600x400/e0f2fe/0c4a6e?text=${nome || 'Foto'}`;

            // Prepara l'oggetto (assicurati che user_id sia incluso!)
            const nuovoLuogo = {
                nome: nome,
                posizione: posizione,
                tags: tags.split(',').map(tag => tag.trim().toLowerCase()),
                note: note,
                foto: foto,
                user_id: currentUserId // !!! FONDAMENTALE PER LA SICUREZZA RLS !!!
            };

            // Inserisci i dati nella tabella 'luoghi'
            const { data, error } = await supabaseClient
                .from('luoghi') // NOME DELLA TUA TABELLA
                .insert(nuovoLuogo); 

            if (error) {
                console.error("Errore nell'aggiungere il documento:", error);
            } else {
                console.log("Documento aggiunto:", data);
                // Non serve aggiornare 'luoghiStore' manualmente,
                // il listener realtime (setupRealtimeListener) lo farà per noi!
                
                // Chiudi la modale e resetta il form
                addForm.reset();
                addModal.classList.add('hidden');
            }
        }
        
        // Collega il submit del form
        addForm.addEventListener('submit', addItemToDb);

        // --- 6. LOGICA DI RENDERING E RICERCA ---

        // Renderizza i dati nella UI
        function renderLuoghi(luoghi) {
            searchResults.innerHTML = ''; // Pulisci i risultati
            
            if (luoghi.length === 0) {
                defaultMessage.style.display = 'block';
                defaultMessage.innerHTML = `
                    <i class="ph ph-sparkle text-5xl opacity-50"></i>
                    <p class="mt-2">Il tuo archivio è vuoto. Clicca il <b>+</b> per aggiungere un oggetto!</p>
                `;
            } else {
                defaultMessage.style.display = 'none';
                luoghi.forEach(luogo => {
                    const card = document.createElement('div');
                    card.className = 'risultato-item bg-white p-4 rounded-xl shadow-md transition-all duration-300 hover:shadow-lg cursor-pointer';
                    card.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <img src="${luogo.foto || 'https://placehold.co/80x80/e2e8f0/64748b?text=Foto'}" alt="${luogo.nome}" class="w-20 h-20 rounded-lg object-cover flex-shrink-0">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-800">${luogo.nome || 'Senza nome'}</h3>
                                <div class="flex items-center text-sm text-gray-500 mt-1">
                                    <i class="ph ph-map-pin-line mr-1"></i>
                                    <span>${luogo.posizione || 'Nessuna posizione'}</span>
                                </div>
                            </div>
                            <i class="ph ph-caret-right text-gray-400 text-xl"></i>
                        </div>
                    `;
                    card.addEventListener('click', () => openDetailModal(luogo));
                    searchResults.appendChild(card);
                });
            }
        }
        
        // Funzione di ricerca
        function handleSearch() {
            const query = searchInput.value.toLowerCase().trim();
            
            if (query.length < 2) {
                renderLuoghi(luoghiStore); // Mostra tutto
                return;
            }
            
            const risultatiFiltrati = luoghiStore.filter(luogo => {
                const searchIn = [
                    luogo.nome || '',
                    luogo.posizione || '',
                    luogo.note || '',
                    ...(luogo.tags || [])
                ].join(' ').toLowerCase();
                
                return searchIn.includes(query);
            });
            
            renderLuoghi(risultatiFiltrati); // Mostra filtrati
            
            if (risultatiFiltrati.length === 0) {
                defaultMessage.style.display = 'block';
                defaultMessage.innerHTML = `
                    <i class="ph ph-x-circle text-5xl text-red-400 opacity-50"></i>
                    <p class="mt-2">Nessun risultato per "<b>${query}</b>".</p>
                `;
            }
        }
        
        searchInput.addEventListener('input', handleSearch);

        // --- 7. LOGICA MODALI ---

        function openDetailModal(luogo) {
            modalImg.src = luogo.foto || 'https://placehold.co/600x400/e2e8f0/64748b?text=Foto';
            modalTitle.textContent = luogo.nome || 'Senza nome';
            modalLocation.textContent = luogo.posizione || 'Nessuna posizione';
            modalNotes.textContent = luogo.note || 'Nessuna nota.';
            detailModal.classList.remove('hidden');
        }

        closeDetailModal.addEventListener('click', () => {
            detailModal.classList.add('hidden');
        });
        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) {
                detailModal.classList.add('hidden');
            }
        });

        openAddModalButton.addEventListener('click', () => {
            addModal.classList.remove('hidden');
        });

        closeAddModalButton.addEventListener('click', () => {
            addModal.classList.add('hidden');
            addForm.reset();
        });
        addModal.addEventListener('click', (e) => {
            if (e.target === addModal) {
                addModal.classList.add('hidden');
                addForm.reset();
            }
        });

        // --- 8. PWA Service Worker ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrato:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Registrazione Service Worker fallita:', error);
                    });
            });
        }
        
        // --- 9. INIZIO ---
        // Controlla se le chiavi sono state inserite
        if (SUPABASE_URL === https://hqpgxgxwxrkzicynedsg.supabase.co || SUPABASE_ANON_KEY === eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxcGd4Z3h3eHJremljeW5lZHNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NjA2NDEsImV4cCI6MjA3NzAzNjY0MX0.H8U2pp4ZlqUs2Y7RRk3XhR-_nYVedvaZCaUW8Xw5JBI) {
            loadingMessage.innerHTML = '<p class="text-red-500 font-bold">ERRORE: Le chiavi Supabase non sono state inserite nel file index.html (Passo 2 della guida).</p>';
            console.error("ERRORE: Inserisci le tue chiavi Supabase nel file index.html");
        } else {
            console.log("Supabase client inizializzato.");
            authButtons.classList.remove('hidden');
            loadingMessage.classList.add('hidden');
        }

    </script>

</body>
</html>